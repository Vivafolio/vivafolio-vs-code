name: Tests

on:
  pull_request:
  workflow_dispatch:
  
  # Run the pipeline for each PR part of merge queues as well
  merge_group:

concurrency:
  group: ${{ github.workflow }}-${{ github.repository }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
  
permissions:
  contents: read

jobs:
  tests:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y direnv just

      - name: Install Nix
        uses: metacraft-labs/nixos-modules/.github/install-nix@main
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          cachix-cache: ${{ vars.CACHIX_CACHE }}

      - name: Build & activate the Nix Dev Shell
        run: |
          direnv allow .
          direnv export gha > "$GITHUB_ENV"

      - name: Allow direnv
        run: direnv allow

      - name: Build (just build-all)
        run: just build-all

      - name: Package and block tests
        run: |
          just test-packages
          just test-blocks
          just test-block-integration

      - name: Extension, LSP, and runtime tests
        run: |
          just test-vscode
          just test-lsp-standalone
          just test-runtime-all
          just test-runtime-vivafolioblock

      - name: Block Protocol
        run: |
          just test-blockprotocol-poc

      - name: WebDriverIO tests
        run: |
          just test-wdio

      - name: Scenario and integration suites
        run: |
          just test-scenario-basic-comms
          just test-scenario-callsite-diagnostics
          just test-e2e-blockprotocol-integration
