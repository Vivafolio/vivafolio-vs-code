<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Color Picker Block</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 12px;
      background: transparent;
    }

    .color-picker-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-start;
    }

    .color-picker-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--vscode-foreground, #cccccc);
    }

    .color-picker-input {
      width: 60px;
      height: 32px;
      border: 1px solid var(--vscode-input-border, #3e3e42);
      border-radius: 3px;
      background: var(--vscode-input-background, #3c3c3c);
      cursor: pointer;
    }

    .color-picker-input:focus {
      outline: 1px solid var(--vscode-focusBorder, #0078d4);
      outline-offset: -1px;
    }

    .error-indicator {
      color: #f48771;
      font-size: 16px;
      display: none;
      cursor: help;
    }

    .error-indicator.visible {
      display: inline;
    }
  </style>
</head>
<body>
  <div class="color-picker-container">
    <label class="color-picker-label">
      Pick color:
      <input id="colorPicker" type="color" class="color-picker-input" value="#ff0000">
      <span id="errorIndicator" class="error-indicator" title="Graph error occurred">⚠️</span>
    </label>
  </div>

  <script>
    const colorPicker = document.getElementById('colorPicker');
    const errorIndicator = document.getElementById('errorIndicator');

    let entityId = null;
    let vscodeApi = null;
    let isInitialized = false;

    // Logging utility
    function log(message, level = 'info') {
      const prefix = '[COLOR-PICKER]';
      const fullMessage = `${prefix} ${message}`;

      switch (level) {
        case 'error':
          console.error(fullMessage);
          break;
        case 'warn':
          console.warn(fullMessage);
          break;
        default:
          console.log(fullMessage);
      }

      // Also send log to extension if available
      if (vscodeApi) {
        vscodeApi.postMessage({
          type: 'log',
          message: fullMessage,
          level: level
        });
      }
    }

    // Message sending utility
    function sendMessage(message) {
      log(`Sending message: ${JSON.stringify(message)}`);

      try {
        // Acquire VS Code API only once
        if (!vscodeApi && typeof acquireVsCodeApi === 'function') {
          vscodeApi = acquireVsCodeApi();
        }

        // Send message via VS Code API or fallback to parent
        (vscodeApi || parent).postMessage(message);
      } catch (error) {
        log(`Error sending message: ${error.message}`, 'error');
      }
    }

    // Handle graph update messages
    function handleGraphUpdate(message) {
      const entity = message.payload?.entities?.[0];
      log(`Processing graph:update with entity: ${JSON.stringify(entity)}`);

      if (entity && typeof entity.properties?.color === 'string') {
        const newColor = entity.properties.color;
        const oldColor = colorPicker.value;
        const oldEntityId = entityId;

        // Update the color picker value
        colorPicker.value = newColor;
        entityId = entity.entityId || entityId;

        log(`Updated color from ${oldColor} to ${newColor}, entityId: ${oldEntityId} → ${entityId}`);

        // Hide error indicator on successful update
        errorIndicator.classList.remove('visible');

        // If this is the first update (initialization), mark as initialized
        if (!isInitialized) {
          isInitialized = true;
          log('Block initialized with initial state');
        }
      } else {
        log(`Invalid entity data received: ${JSON.stringify(entity)}`, 'warn');
      }
    }

    // Handle graph error messages
    function handleGraphError(message) {
      log(`Graph error received: ${JSON.stringify(message.error)}`, 'error');
      errorIndicator.classList.add('visible');
      errorIndicator.title = `Graph error: ${message.error?.message || 'Unknown error'}`;
    }

    // Color picker input handler
    function handleColorChange() {
      if (!isInitialized || !entityId) {
        log('Ignoring color change - block not fully initialized', 'warn');
        return;
      }

      const newColor = colorPicker.value;
      log(`User selected color: ${newColor}`);

      // Send entity update to extension
      const updateMessage = {
        type: 'graph:update',
        payload: {
          entities: [{
            entityId: entityId,
            properties: { color: newColor }
          }],
          links: []
        }
      };

      sendMessage(updateMessage);
    }

    // Message event listener
    window.addEventListener('message', (event) => {
      const message = event.data;

      if (!message || typeof message !== 'object') {
        return;
      }

      log(`Received message: ${JSON.stringify(message)}`);

      switch (message.type) {
        case 'graph:update':
          handleGraphUpdate(message);
          break;

        case 'graph:error':
          handleGraphError(message);
          break;

        case 'ready':
          // Extension acknowledges our ready message
          log('Extension acknowledged ready state');
          break;

        default:
          log(`Ignoring unknown message type: ${message.type}`);
      }
    });

    // Input event listener
    colorPicker.addEventListener('input', handleColorChange);
    colorPicker.addEventListener('change', handleColorChange);

    // Send ready message to signal block is loaded
    log('Color picker block initialized and ready');
    sendMessage({ type: 'ready' });
  </script>
</body>
</html>
